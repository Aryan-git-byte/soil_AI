services:
  # FastAPI Backend
  - type: web
    name: farmbot-nova-backend
    env: python
    region: oregon # or your preferred region like 'singapore'
    plan: free
    buildCommand: pip install -r requirements.txt
    startCommand: ./start.sh
    healthCheckPath: /health
    
    envVars:
      # ======================================
      # CRITICAL MEMORY SETTINGS (512MB Tier)
      # ======================================
      - key: MALLOC_ARENA_MAX
        value: 2 # Reduces memory fragmentation (Crucial for glibc)
      - key: PYTHONUNBUFFERED
        value: 1
      - key: WEB_CONCURRENCY
        value: 1 # Forces 1 worker just in case

      # ======================================
      # APPLICATION CONFIG
      # ======================================
      - key: ENVIRONMENT
        value: production
      - key: PYTHON_VERSION
        value: 3.10.11
      
      # ======================================
      # API KEYS & SECRETS (Sync from Dashboard)
      # ======================================
      
      # AI Providers (Matched to start.sh requirements)
      - key: GROQ_API_KEY
        sync: false
      - key: OPENROUTER_API_KEY_1
        sync: false
      
      # Vector DB
      - key: QDRANT_URL
        sync: false
      - key: QDRANT_API_KEY
        sync: false
      - key: QDRANT_COLLECTION
        value: farmbot_knowledge
      
      # Database
      - key: SUPABASE_URL
        sync: false
      - key: SUPABASE_KEY
        sync: false
      
      # External Tools
      - key: OPENWEATHER_API_KEY
        sync: false
      - key: TAVILY_API_KEY
        sync: false
      
      # Security
      - key: ADMIN_SECRET
        generateValue: true
      - key: API_KEYS
        sync: false
      - key: ALLOWED_ORIGINS
        value: https://farmbot-nova-frontend.onrender.com
      
      # Soil Data Configuration
      - key: SOIL_SAND_FILE
        value: /opt/render/project/src/data/soil/sand.tif
      - key: SOIL_CLAY_FILE
        value: /opt/render/project/src/data/soil/clay.tif
      - key: SOIL_SILT_FILE
        value: /opt/render/project/src/data/soil/silt.tif
      - key: SOIL_TEXTURE_FILE
        value: /opt/render/project/src/data/soil/texture.tif

  # Static Frontend
  - type: web
    name: farmbot-nova-frontend
    env: static
    buildCommand: echo "No build needed for static site"
    staticPublishPath: .
    routes:
      - type: rewrite
        source: /*
        destination: /index.html