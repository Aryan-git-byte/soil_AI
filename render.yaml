services:
  # FastAPI Backend
  - type: web
    name: farmbot-nova-backend
    env: python
    region: oregon
    plan: free
    buildCommand: pip install -r requirements.txt
    startCommand: ./start.sh
    healthCheckPath: /health
    
    envVars:
      # ======================================
      # MEMORY OPTIMIZATION (512MB)
      # ======================================
      - key: MALLOC_ARENA_MAX
        value: 2
      - key: WEB_CONCURRENCY
        value: 1

      # ======================================
      # SECURITY & INTEGRITY
      # ======================================
      # Hash retrieved from your error logs:
      - key: MODEL_HASH
        value: 3199e130d71eaf4cf7902b21d028a730b3ffdf2329d0918ef66e1346490c7197
      
      # Hash for labels.pkl (Check Render logs after deploy to get the real value!)
      - key: LABELS_HASH
        value: replace_with_actual_sha256_hash_of_labels_pkl

      # ======================================
      # ENVIRONMENT
      # ======================================
      - key: ENVIRONMENT
        value: production
      - key: PYTHON_VERSION
        value: 3.10.11

      # ======================================
      # KEYS & API CONFIG
      # ======================================
      - key: GROQ_API_KEY
        sync: false
      - key: OPENROUTER_API_KEY_1
        sync: false
      - key: OPENWEATHER_API_KEY
        sync: false
      - key: TAVILY_API_KEY
        sync: false
        
      # Database & Vector DB
      - key: QDRANT_URL
        sync: false
      - key: QDRANT_API_KEY
        sync: false
      - key: QDRANT_COLLECTION
        value: farmbot_knowledge
      - key: SUPABASE_URL
        sync: false
      - key: SUPABASE_KEY
        sync: false
      
      # App Secrets
      - key: ADMIN_SECRET
        generateValue: true
      - key: API_KEYS
        sync: false
      - key: ALLOWED_ORIGINS
        value: https://farmbot-nova-frontend.onrender.com

      # Data Paths
      - key: SOIL_SAND_FILE
        value: /opt/render/project/src/data/soil/sand.tif
      - key: SOIL_CLAY_FILE
        value: /opt/render/project/src/data/soil/clay.tif
      - key: SOIL_SILT_FILE
        value: /opt/render/project/src/data/soil/silt.tif
      - key: SOIL_TEXTURE_FILE
        value: /opt/render/project/src/data/soil/texture.tif

  # Static Frontend
  - type: web
    name: farmbot-nova-frontend
    env: static
    buildCommand: echo "No build needed for static site"
    staticPublishPath: .
    routes:
      - type: rewrite
        source: /*
        destination: /index.html